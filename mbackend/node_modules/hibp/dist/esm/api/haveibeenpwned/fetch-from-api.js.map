{"version":3,"file":"fetch-from-api.js","sources":["../../../../src/api/haveibeenpwned/fetch-from-api.ts"],"sourcesContent":["import type { PackageJson } from 'type-fest';\nimport { installUndiciOnNode18 } from '../fetch-polyfill.js';\nimport { BAD_REQUEST, UNAUTHORIZED, FORBIDDEN, NOT_FOUND, TOO_MANY_REQUESTS } from './responses.js';\nimport type { ApiData, ErrorData } from './types.js';\n\ninstallUndiciOnNode18();\n\n/**\n * Custom error thrown when the haveibeenpwned.com API responds with 429 Too\n * Many Requests. See the `retryAfterSeconds` property for the number of seconds\n * to wait before attempting the request again.\n *\n * @see https://haveibeenpwned.com/API/v3#RateLimiting\n */\nexport class RateLimitError extends Error {\n  /**\n   * The number of seconds to wait before attempting the request again. May be\n   * `undefined` if the API does not provide a `retry-after` header, but this\n   * should never happen.\n   */\n  public retryAfterSeconds: number | undefined;\n\n  constructor(\n    retryAfter: ReturnType<Headers['get']>,\n    message: string | undefined,\n    options?: ErrorOptions,\n  ) {\n    super(message, options);\n    this.name = this.constructor.name;\n    this.retryAfterSeconds =\n      typeof retryAfter === 'string'\n        ? Number.parseInt(retryAfter, 10) /* c8 ignore start */\n        : undefined; /* c8 ignore stop */\n  }\n}\n\nfunction blockedWithRayId(rayId: string) {\n  return `Request blocked, contact haveibeenpwned.com if this continues (Ray ID: ${rayId})`;\n}\n\n/**\n * Fetches data from the supplied API endpoint.\n *\n * HTTP status code 200 returns an Object (data found).\n * HTTP status code 404 returns null (no data found).\n * HTTP status code 400 throws an Error (bad request).\n * HTTP status code 401 throws an Error (unauthorized).\n * HTTP status code 403 throws an Error (forbidden).\n * HTTP status code 429 throws an Error (too many requests).\n *\n * @internal\n * @private\n * @param {string} endpoint the API endpoint to query\n * @param {object} [options] a configuration object\n * @param {string} [options.apiKey] an API key from\n * https://haveibeenpwned.com/API/Key\n * @param {string} [options.baseUrl] a custom base URL for the\n * haveibeenpwned.com API endpoints (default:\n * `https://haveibeenpwned.com/api/v3`)\n * @param {number} [options.timeoutMs] timeout for the request in milliseconds\n * (default: none)\n * @param {string} [options.userAgent] a custom string to send as the User-Agent\n * field in the request headers (default: `hibp <version>`)\n * @returns {Promise<ApiData>} a Promise which resolves to the data resulting\n * from the query (or null for 404 Not Found responses), or rejects with an\n * Error\n */\nexport async function fetchFromApi(\n  endpoint: string,\n  options: {\n    apiKey?: string;\n    baseUrl?: string;\n    timeoutMs?: number;\n    userAgent?: string;\n  } = {},\n): Promise<ApiData> {\n  const { apiKey, baseUrl = 'https://haveibeenpwned.com/api/v3', timeoutMs, userAgent } = options;\n  const headers: Record<string, string> = {};\n\n  if (apiKey) {\n    headers['HIBP-API-Key'] = apiKey;\n  }\n\n  if (userAgent) {\n    headers['User-Agent'] = userAgent;\n  }\n\n  // Provide a default User-Agent when running outside the browser\n  if (!userAgent && typeof navigator === 'undefined') {\n    const { name, version } = (await import('../../../package.json', {\n      assert: { type: 'json' },\n    })) as unknown as PackageJson;\n    headers['User-Agent'] = `${name} ${version}`;\n  }\n\n  const config: RequestInit = {\n    headers,\n    ...(timeoutMs ? { signal: AbortSignal.timeout(timeoutMs) } : {}),\n  };\n  const url = `${baseUrl.replace(/\\/$/g, '')}${endpoint}`;\n  const response = await fetch(url, config);\n\n  if (response.ok) return response.json() as Promise<ApiData>;\n\n  switch (response.status) {\n    case BAD_REQUEST.status: {\n      throw new Error(BAD_REQUEST.statusText);\n    }\n    case UNAUTHORIZED.status: {\n      const message = await response.text();\n      throw new Error(message);\n    }\n    case FORBIDDEN.status: {\n      const rayId = response.headers.get('cf-ray');\n      if (rayId) throw new Error(blockedWithRayId(rayId));\n      throw new Error(FORBIDDEN.statusText);\n    }\n    case NOT_FOUND.status: {\n      return null;\n    }\n    case TOO_MANY_REQUESTS.status: {\n      const body = (await response.json()) as unknown as ErrorData;\n      const retryAfter = response.headers.get('retry-after');\n      throw new RateLimitError(retryAfter, body.message);\n    }\n    default: {\n      throw new Error(response.statusText);\n    }\n  }\n}\n"],"names":["installUndiciOnNode18","RateLimitError","Error","retryAfterSeconds","constructor","retryAfter","message","options","name","Number","parseInt","undefined","blockedWithRayId","rayId","fetchFromApi","endpoint","apiKey","baseUrl","timeoutMs","userAgent","headers","navigator","version","config","signal","AbortSignal","timeout","url","replace","response","fetch","ok","json","status","BAD_REQUEST","statusText","UNAUTHORIZED","text","FORBIDDEN","get","NOT_FOUND","TOO_MANY_REQUESTS","body"],"mappings":"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"}